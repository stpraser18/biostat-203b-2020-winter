---
title: "Biostat 203B Homework 2 Solutions"
author: Supasara Prasertphong
subtitle: Due Feb 7 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-III](https://mimic.physionet.org) data introduced in [homework 1](https://ucla-biostat203b-2020winter.github.io/hw/hw1/hw1.html).

## Q1

Demographic information of the patients admitted into hospital is available in `ADMISSION.csv`. See <https://mimic.physionet.org/mimictables/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs:   

  - admission year  
- admission month  
- admission week day  
- admission hour
- length of hospital stay  
- admission type  
- number of admissions per patient  
- admission location  
- insurance  
- language  
- religion  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on only unique patients. 

**Solution**

```{r}
library (tidyverse)
library (lubridate)
library (dplyr)
```

##Import data
````{bash}
head /home/203bdata/mimic-iii/ADMISSIONS.csv
```

```{r}
admissions <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv") 
admissions
admissions %>% print(width = Inf)
```

#Found unique values
```{r}
admissionsunique <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv")
  admissionsunique %>% 
  summarise_all(n_distinct) %>%
  select (SUBJECT_ID)
```

#Listed all the unique values
```{r}
admissionsunique <- read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv")
  admissionsunique %>% 
  distinct(SUBJECT_ID)
```

#Admission year bar graph
```{r}
admissions %>%
  mutate(adm_year = year(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_year))
```

#Admission month bar graph
```{r}
admissions %>%
  mutate(adm_month = month(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_month))
```

#Admission week day
```{r}
admissions %>%
  mutate(wday = wday(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = wday))
```
#Admission hour
```{r}
admissions %>%
  mutate(hour = hour(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = hour))
```

#Length of stay
```{r}
admissions %>%
  mutate(los_days = as.numeric(as.duration(DISCHTIME - ADMITTIME) / 86400)) %>%
  ggplot(aes(x = los_days)) + 
  geom_histogram (bins = 100) + 
  labs(x = "Length of Stay (days)")
```

#Admission Type
```{r}
admissions %>% 
  group_by(ADMISSION_TYPE) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = ADMISSION_TYPE, y = count)) +
  geom_col()
#%>%
 # mutate(freq = N / sum(N),
  #pct = round((freq*100), 0))
```

#Number of Admissions/Patient
``` {bash}
cut -d ',' -f2 /home/203bdata/mimic-iii/ADMISSIONS.csv | sort -u | wc -l
```

#Admission Location
```{r}
admissions %>% 
  group_by(ADMISSION_LOCATION) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = ADMISSION_LOCATION, y = count)) +
  geom_col() +  
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

#Insurance sorted by unique values using distinct
```{r}
admissions %>% 
  group_by(INSURANCE) %>%
  distinct(SUBJECT_ID) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = INSURANCE, y = count)) +
  geom_col() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

#Insurance without unique values
```{r}
admissions %>% 
  group_by(INSURANCE) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = INSURANCE, y = count)) +
  geom_col() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

#Language
```{r}
admissions %>% 
  group_by(LANGUAGE) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = LANGUAGE, fill = count)) +
  geom_bar(width = 1) +
  coord_polar("y")
```

#Religion
```{r}
admissions %>% 
  group_by(RELIGION) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = RELIGION, y = count)) +
  geom_col() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

#Marital Status
```{r}
admissions %>% 
  group_by(MARITAL_STATUS) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = MARITAL_STATUS, y = count)) +
  geom_col() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

#Ethnicity
```{r}
admissions %>% 
  group_by(ETHNICITY) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = ETHNICITY, y = count)) +
  geom_col() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```


#Death
#```{r}
admissions %>% 
  group_by(DEATHTIME) %>%
  summarize(count = n(DEATHTIME)) %>%
  ggplot(aes(x = DEATHTIME, y = count)) +
  geom_bar() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```


## Q2

Link the data in `ADMISSION.csv` and `PATIENTS.csv` (<https://mimic.physionet.org/mimictables/patients/>) and summarize following variables using appropriate graphs:  

- gender  
- age at admission

```{r}
patients <- read_csv("/home/203bdata/mimic-iii/PATIENTS.csv") 
patients
```

#Extracted subject_id column from admissions 
```{r}
admissions2 <- admissions %>% 
  select (SUBJECT_ID)
  admissions2
```


#Extracted subject_id and gender from patients to merge together
```{r}
patients2 <- patients %>% 
  select (SUBJECT_ID, GENDER)
  patients2
```


#Merged the subject_id's together to determine their gender
```{r}
left_join(admissions2, patients2) %>%
group_by(GENDER) %>%
  summarize(count = n()) %>%
  ggplot() + 
  geom_col(mapping = aes(x = GENDER, y = count))
```

#Extracted subject_id and admission time, also need to extract year
```{r}
admissions3 <- admissions %>% 
  select (SUBJECT_ID, ADMITTIME) %>%
  mutate(adm_year = year(ADMITTIME)) %>%
  select(SUBJECT_ID, -ADMITTIME, adm_year)
  admissions3
```

#Extracted subject_id and date of birth, need to extract year
```{r}
patients3 <- patients %>% 
  select (SUBJECT_ID, DOB) %>%
  mutate(dateofbirth = year(DOB)) %>%
  select (SUBJECT_ID, -DOB, dateofbirth)
  patients3
```

#Joined subject id, year of birth, and year of admission together, need to create new column for age
#```{r}
left_join(admissions3, patients3) %>%
  mutate(age_adm = adm_year - dateofbirth)
  ggplot() +
  geom_dotplot(aes(x = age_adm, y = count))
```

#Create graph according to age of admission
#```{r}
left_join(admissions3, patients3) %>%
  group_by(age_adm) %>%
  summarize(age_adm_count = n(age_adm)) %>%
  ggplot(aes(x = age_adm, y = count)) +
  geom_dotplot()
```

## Q3

`ICUSTAYS.csv` (<https://mimic.physionet.org/mimictables/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate graphs:  

- length of ICU stay  
- first ICU unit  
- gender  
- age  

```{r}
library(lubridate)
```

#Load ICUSTAYS file
```{r}
icustays <- read_csv("/home/203bdata/mimic-iii/ICUSTAYS.csv")
icustays
```

#Length of ICUSTAYS
```{r}
icustays %>%
  select(INTIME, OUTTIME) %>%
  mutate(icu_in_hour = hour(INTIME)) %>%
  mutate(icu_out_hour = hour(OUTTIME))
```



## Q4 

`CHARTEVENTS.csv` (<https://mimic.physionet.org/mimictables/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`D_ITEMS.csv` (<https://mimic.physionet.org/mimictables/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

Compile a tibble that contains the first ICU stay of unique patients, with the patient's demographic information, the first systolic blood pressure measurement during ICU stay, and whether the patient died within 30 days of hospitcal admission.
